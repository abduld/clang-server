machine:
  environment:
    TERM: xterm-256color
    GOROOT: "/home/ubuntu/go"
    PATH: "/home/ubuntu/go/bin:$PATH"
    GOLANG_VERSION: 1.8beta1
    COVERAGE_SERVICE: codecov
    CGO_LDFLAGS: "-L /usr/lib/llvm-3.9/lib"

dependencies:
  cache_directories:
    - "/home/ubuntu/.go"
  pre:
    - echo 'deb http://apt.llvm.org/trusty/ llvm-toolchain-trusty-3.9 main' | sudo tee -a /etc/apt/sources.list
    - wget -O - http://apt.llvm.org/llvm-snapshot.gpg.key|sudo apt-key add -
    - sudo apt-get update; sudo apt-get install clang-3.9 lldb-3.9
    - sudo ln -s $(llvm-config-3.9 --libdir)/libclang-3.9.so.1 $(llvm-config-3.9 --libdir)/libclang.so
    - >
      if [[ ! -e "/home/ubuntu/.go/${GOLANG_VERSION}/bin/go" ]]; then
        cd /home/ubuntu
        curl https://storage.googleapis.com/golang/go${GOLANG_VERSION}.linux-amd64.tar.gz | tar -xz
        mkdir -p ~/.go
        cp -rp /home/ubuntu/go /home/ubuntu/.go/${GOLANG_VERSION}
      else
        cp -rp /home/ubuntu/.go/${GOLANG_VERSION} ~/go
      fi
    - go version
    - go get -u github.com/Masterminds/glide
    - go get -u github.com/golang/lint/golint
  override:
    - go get -t -d -v ./...
    - go build -v ./...

test:
  override:
    - ./scripts/coverrage.bash codecov
  post:
    - bash <(curl -s https://codecov.io/bash)
    - test -z "$(gofmt -e -s -l -w $(find . -not -iwholename '*vendor*' -and -name '*.go' -print) | tee /dev/stderr)"
    - test -z "$(golint $(go list ./... | grep -v vendor) | tee /dev/stderr)"
    - go vet $(glide nv)
